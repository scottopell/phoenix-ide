# Patch Tool

## User Story

As an LLM agent, I need to edit files precisely so that I can modify code, configuration, and documentation without rewriting entire files or making transcription errors.

## Requirements

### REQ-PATCH-001: File Operations

WHEN agent requests file modification
THE SYSTEM SHALL support four operations:
- `replace`: Substitute unique text with new content
- `append_eof`: Append text at end of file
- `prepend_bof`: Insert text at beginning of file
- `overwrite`: Replace entire file contents (creates file if missing)

WHEN replace operation is requested
THE SYSTEM SHALL require oldText to appear exactly once in the file

WHEN file does not exist
THE SYSTEM SHALL allow only append_eof, prepend_bof, and overwrite operations
AND create parent directories as needed

**Rationale:** Agents need precise, predictable file editing. Requiring unique matches prevents ambiguous edits that could corrupt files.

---

### REQ-PATCH-002: Multiple Patches Per Call

WHEN agent provides multiple patches for a single file
THE SYSTEM SHALL apply all patches atomically
AND apply them against the original file content simultaneously

WHEN any patch fails to apply
THE SYSTEM SHALL reject the entire operation
AND leave the file unchanged

**Rationale:** Agents often need multiple related edits. Atomic application prevents partial modifications that leave files in broken states.

---

### REQ-PATCH-003: Clipboard Operations

WHEN agent specifies toClipboard on a replace operation
THE SYSTEM SHALL store the matched oldText to the named clipboard
AND complete the replace operation

WHEN agent specifies fromClipboard
THE SYSTEM SHALL use clipboard content as newText
AND ignore any provided newText field

WHEN clipboard is referenced but does not exist
THE SYSTEM SHALL return error indicating missing clipboard

WHEN agent uses same clipboard name for toClipboard and fromClipboard
THE SYSTEM SHALL perform a copy operation (text remains unchanged)

**Rationale:** Clipboards enable cut/copy/paste workflows that reduce transcription errors when moving code within or across files.

---

### REQ-PATCH-004: Indentation Adjustment

WHEN agent specifies reindent with strip prefix
THE SYSTEM SHALL remove that prefix from each non-empty line of inserted text

WHEN agent specifies reindent with add prefix
THE SYSTEM SHALL add that prefix to each non-empty line of inserted text

WHEN strip prefix is not present on a non-empty line
THE SYSTEM SHALL return error indicating strip precondition failed

**Rationale:** Agents frequently move code between different indentation levels. Explicit reindentation prevents whitespace errors.

---

### REQ-PATCH-005: Fuzzy Matching Recovery

WHEN exact oldText match fails
THE SYSTEM SHALL attempt recovery via whitespace normalization:
- Adjust leading whitespace prefix (dedent matching)
- Trim first/last lines if safe

WHEN fuzzy match succeeds
THE SYSTEM SHALL apply the patch using matched boundaries
AND update any toClipboard with actual matched text

WHEN all matching attempts fail
THE SYSTEM SHALL return error with "old text not found" message

**Rationale:** LLMs occasionally generate patches with minor whitespace differences. Safe recovery improves reliability without compromising precision.

---

### REQ-PATCH-006: Tool Schema

WHEN LLM requests patch tool
THE SYSTEM SHALL provide schema with:
- `path` (required string): File path relative to working directory
- `patches` (required array): List of patch operations

WHEN patch operation is specified
THE SYSTEM SHALL accept:
- `operation` (required enum): replace, append_eof, prepend_bof, overwrite
- `oldText` (string): Text to locate (required for replace)
- `newText` (string): Replacement text
- `toClipboard` (string): Named clipboard to store oldText
- `fromClipboard` (string): Named clipboard to use as newText
- `reindent` (object): Strip and add prefixes for indentation

**Rationale:** Structured schema enables precise file editing with optional clipboard and reindentation features.

---

### REQ-PATCH-007: Output and Display

WHEN patches are applied successfully
THE SYSTEM SHALL return confirmation to LLM
AND generate unified diff for UI display

WHEN file appears to be autogenerated
THE SYSTEM SHALL include warning in response
AND apply patches anyway

WHEN clipboard contents are modified during fuzzy matching
THE SYSTEM SHALL notify LLM of the modification

**Rationale:** Clear feedback helps agents verify edits. Diffs enable user review. Autogenerated warnings prevent accidental modifications to generated code.

---

### REQ-PATCH-008: Size Limits

WHEN patch input exceeds 60k tokens
THE SYSTEM SHALL reject the operation
AND suggest breaking into smaller patches

**Rationale:** Large patches risk context window issues and are harder to review. Incremental edits are preferred.

---

### REQ-PATCH-009: Mode-Based Availability

WHEN conversation is in Restricted mode
THE SYSTEM SHALL disable the patch tool entirely
AND return error: "Patch tool is disabled in Restricted mode. Use request_mode_upgrade to request write access."

WHEN conversation is in Unrestricted mode
THE SYSTEM SHALL enable full patch tool functionality

WHEN mode changes from Unrestricted to Restricted
THE SYSTEM SHALL immediately disable patch tool
AND NOT affect any in-flight operations (mode change waits for idle)

**Rationale:** Patch writes files and must be disabled in read-only mode. Phoenix-level enforcement provides clear, actionable error messages guiding agents to request appropriate permissions.
